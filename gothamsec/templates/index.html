{% extends "base.html" %}

{% block title %}Home - {{ get_config("ctf_name") }}{% endblock %}

{% block content %}
<!-- Hero Section with Full Circuit Animation -->
<div class="hero" style="min-height: 80vh;">
    <div class="hero-background">
        <canvas id="hero-circuit-canvas"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
    </div>

    <div class="hero-content">
        <!-- Animated Logo -->
        <svg class="animate-float" viewBox="0 0 100 100" width="150" height="150"
            style="margin-bottom: 2rem; filter: drop-shadow(0 0 30px rgba(0, 217, 255, 0.5));">
            <defs>
                <linearGradient id="heroLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#00d9ff" />
                    <stop offset="100%" style="stop-color:#b026ff" />
                </linearGradient>
            </defs>
            <path d="M50 5 L90 25 L90 55 Q90 75 50 95 Q10 75 10 55 L10 25 Z" fill="none" stroke="url(#heroLogoGradient)"
                stroke-width="3" />
            <path d="M50 30 L35 45 L20 40 L30 55 L25 70 L50 60 L75 70 L70 55 L80 40 L65 45 Z"
                fill="url(#heroLogoGradient)" />
            <!-- Animated circuit lines -->
            <path d="M30 50 L40 50 L45 55 L55 55 L60 50 L70 50" fill="none" stroke="#00d9ff" stroke-width="1.5"
                stroke-dasharray="100" stroke-dashoffset="100">
                <animate attributeName="stroke-dashoffset" from="100" to="0" dur="2s" repeatCount="indefinite" />
            </path>
        </svg>

        <h1 class="hero-title">{{ get_config("ctf_name") }}</h1>
        <p class="hero-subtitle">
            {{ get_config("ctf_description") or "Enter the arena. Prove your skills. Capture the flags." }}
        </p>

        <div class="d-flex gap-2 justify-center" style="flex-wrap: wrap;">
            {% if authed() %}
            <a href="{{ url_for('challenges.listing') }}" class="btn btn-primary btn-lg">
                Enter Challenges
            </a>
            <a href="{{ url_for('scoreboard.listing') }}" class="btn btn-secondary btn-lg">
                View Scoreboard
            </a>
            {% else %}
            {% if get_config('registration_visibility') != False %}
            <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-lg">
                Join the Arena
            </a>
            {% endif %}
            <a href="{{ url_for('auth.login') }}" class="btn btn-secondary btn-lg">
                Access Terminal
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stats Section -->
<section class="container" style="padding: 4rem 0;">
    <div class="d-flex gap-3 justify-center" style="flex-wrap: wrap;">
        <div class="glass-panel text-center animate-fade-in-up" style="min-width: 200px; padding: 2rem;">
            <div class="text-cyan" style="font-size: 3rem; font-weight: 700;" id="stat-challenges">--</div>
            <div class="text-muted">Challenges</div>
        </div>
        <div class="glass-panel text-center animate-fade-in-up"
            style="min-width: 200px; padding: 2rem; animation-delay: 0.1s;">
            <div class="text-purple" style="font-size: 3rem; font-weight: 700;" id="stat-teams">--</div>
            <div class="text-muted">{{ 'Teams' if get_config('user_mode') == 'teams' else 'Players' }}</div>
        </div>
        <div class="glass-panel text-center animate-fade-in-up"
            style="min-width: 200px; padding: 2rem; animation-delay: 0.2s;">
            <div class="text-cyan" style="font-size: 3rem; font-weight: 700;" id="stat-solves">--</div>
            <div class="text-muted">Total Solves</div>
        </div>
    </div>
</section>

<!-- Recent Activity (Optional) -->
<section class="container" style="padding: 2rem 0 4rem;">
    <h2 class="text-center mb-4">Recent Activity</h2>
    <div class="glass-panel" id="recent-activity" style="max-height: 300px; overflow-y: auto;">
        <div class="text-center text-muted">Loading activity...</div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        // Initialize hero canvas
        const heroCanvas = document.getElementById('hero-circuit-canvas');
        if (heroCanvas) {
            new GothamSecCircuitBoard(heroCanvas);
        }

        // Fetch stats
        async function fetchStats() {
            try {
                // Challenges
                const chalResp = await fetch('/api/v1/challenges');
                const chalData = await chalResp.json();
                if (chalData.success) {
                    document.getElementById('stat-challenges').textContent = chalData.data.length;
                }

                // Teams/Users
                const mode = '{{ get_config("user_mode") }}';
                const endpoint = mode === 'teams' ? '/api/v1/teams' : '/api/v1/users';
                const teamsResp = await fetch(endpoint);
                const teamsData = await teamsResp.json();
                if (teamsData.success) {
                    document.getElementById('stat-teams').textContent = teamsData.data.length;
                }

                // Approximate solves from scoreboard
                const scoreResp = await fetch('/api/v1/scoreboard/top/100');
                const scoreData = await scoreResp.json();
                if (scoreData.success) {
                    const totalScore = scoreData.data.reduce((acc, t) => acc + t.score, 0);
                    document.getElementById('stat-solves').textContent = Math.floor(totalScore / 100);
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        // Fetch recent activity
        async function fetchActivity() {
            const activityEl = document.getElementById('recent-activity');
            try {
                const response = await fetch('/api/v1/scoreboard/top/10');
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    activityEl.innerHTML = data.data.slice(0, 5).map(entry => `
                    <div class="d-flex justify-between align-center" style="padding: 0.75rem 0; border-bottom: 1px solid var(--gth-gray-medium);">
                        <span class="text-cyan">${entry.name}</span>
                        <span class="text-purple">${entry.score} pts</span>
                    </div>
                `).join('');
                } else {
                    activityEl.innerHTML = '<div class="text-center text-muted">No activity yet</div>';
                }
            } catch (error) {
                activityEl.innerHTML = '<div class="text-center text-muted">Could not load activity</div>';
            }
        }

        fetchStats();
        fetchActivity();
    })();
</script>
{% endblock %}