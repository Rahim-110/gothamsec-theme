{% extends "base.html" %}

{% block title %}Scoreboard - {{ get_config("ctf_name") }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="hero" style="min-height: 30vh; padding: 2rem 0;">
        <div class="hero-content">
            <h1 class="hero-title">Scoreboard</h1>
            <p class="hero-subtitle">Real-time rankings. Who will claim the crown?</p>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="d-flex justify-center gap-3 mb-4" style="flex-wrap: wrap;">
        <div class="glass-panel text-center" style="padding: 1.5rem 2rem; min-width: 150px;">
            <div class="text-cyan" style="font-size: 2rem; font-weight: 700;" id="total-teams">--</div>
            <div class="text-muted">{{ 'Teams' if get_config('user_mode') == 'teams' else 'Players' }}</div>
        </div>
        <div class="glass-panel text-center" style="padding: 1.5rem 2rem; min-width: 150px;">
            <div class="text-purple" style="font-size: 2rem; font-weight: 700;" id="total-solves">--</div>
            <div class="text-muted">Total Solves</div>
        </div>
        <div class="glass-panel text-center" style="padding: 1.5rem 2rem; min-width: 150px;">
            <div class="text-cyan" style="font-size: 2rem; font-weight: 700;" id="total-challenges">--</div>
            <div class="text-muted">Challenges</div>
        </div>
    </div>

    <!-- Score Graph -->
    <div class="glass-panel mb-4">
        <h3 class="text-cyan mb-3" style="text-align: center;">Top 10 {{ 'Teams' if get_config('user_mode') == 'teams'
            else 'Players' }}</h3>
        <div style="position: relative; height: 400px;">
            <canvas id="score-graph"></canvas>
        </div>
    </div>

    <!-- Top 3 Podium -->
    <div class="d-flex justify-center align-center gap-3 mb-4" id="podium" style="flex-wrap: wrap; display: none;">
        <!-- 2nd Place -->
        <div class="glass-panel text-center podium-item" id="podium-2" style="padding: 2rem; min-width: 200px;">
            <div class="text-muted" style="font-size: 3rem;">ðŸ¥ˆ</div>
            <h3 class="podium-name">--</h3>
            <div class="podium-score text-cyan">--</div>
        </div>
        <!-- 1st Place -->
        <div class="glass-panel text-center podium-item" id="podium-1"
            style="padding: 2rem; min-width: 220px; transform: scale(1.1);">
            <div style="font-size: 4rem;">ðŸ¥‡</div>
            <h3 class="podium-name">--</h3>
            <div class="podium-score text-cyan" style="font-size: 1.5rem;">--</div>
        </div>
        <!-- 3rd Place -->
        <div class="glass-panel text-center podium-item" id="podium-3" style="padding: 2rem; min-width: 200px;">
            <div class="text-muted" style="font-size: 3rem;">ðŸ¥‰</div>
            <h3 class="podium-name">--</h3>
            <div class="podium-score text-cyan">--</div>
        </div>
    </div>

    <!-- Scoreboard Table -->
    <div class="glass-panel">
        <table class="scoreboard-table">
            <thead>
                <tr>
                    <th style="width: 80px;">Place</th>
                    <th>{{ 'Team' if get_config('user_mode') == 'teams' else 'Player' }}</th>
                    <th style="width: 120px;">Score</th>
                </tr>
            </thead>
            <tbody id="scoreboard-body">
                <!-- Rows loaded dynamically -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>

<script>
    (function () {
        const scoreboardBody = document.getElementById('scoreboard-body');
        const podium = document.getElementById('podium');
        const scoreGraphCanvas = document.getElementById('score-graph');
        let standings = [];
        let maxScore = 0;
        let scoreChart = null;

        // GothamSec color palette for chart
        const chartColors = [
            '#00d9ff', // cyan
            '#b026ff', // purple
            '#ff2a6d', // pink
            '#05d9e8', // green/teal
            '#ff6b35', // orange
            '#ffd700', // gold
            '#7b68ee', // medium slate blue
            '#00ff7f', // spring green
            '#ff1493', // deep pink
            '#1e90ff'  // dodger blue
        ];

        async function fetchScoreboard() {
            try {
                const response = await fetch('/api/v1/scoreboard');

                if (!response.ok) {
                    throw new Error('Scoreboard API returned ' + response.status);
                }

                const data = await response.json();

                if (data.success && data.data) {
                    standings = data.data;
                    if (standings.length > 0) {
                        maxScore = standings[0].score || 1;
                    }

                    renderPodium();
                    renderScoreboard();
                    updateStats();
                    fetchGraphData();
                } else {
                    scoreboardBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No scoreboard data available</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching scoreboard:', error);
                scoreboardBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Failed to load scoreboard</td></tr>';
            }
        }

        async function fetchGraphData() {
            try {
                const response = await fetch('/api/v1/scoreboard/top/10');
                if (!response.ok) return;

                const data = await response.json();
                if (data.success && data.data) {
                    renderGraph(data.data);
                }
            } catch (error) {
                console.error('Error fetching graph data:', error);
            }
        }

        function renderGraph(topTeams) {
            if (!topTeams || topTeams.length === 0) return;

            const datasets = [];

            topTeams.forEach((team, index) => {
                if (team.solves && team.solves.length > 0) {
                    // Build cumulative score over time
                    let cumulativeScore = 0;
                    const dataPoints = [];

                    // Sort solves by date
                    const sortedSolves = team.solves.sort((a, b) =>
                        new Date(a.date) - new Date(b.date)
                    );

                    sortedSolves.forEach(solve => {
                        cumulativeScore += solve.value || 0;
                        dataPoints.push({
                            x: new Date(solve.date),
                            y: cumulativeScore
                        });
                    });

                    datasets.push({
                        label: team.name,
                        data: dataPoints,
                        borderColor: chartColors[index % chartColors.length],
                        backgroundColor: chartColors[index % chartColors.length] + '20',
                        tension: 0.1,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }
            });

            if (datasets.length === 0) return;

            // Destroy existing chart if any
            if (scoreChart) {
                scoreChart.destroy();
            }

            scoreChart = new Chart(scoreGraphCanvas, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: 'MMM d, HH:mm'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ccc',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 10, 15, 0.9)',
                            titleColor: '#00d9ff',
                            bodyColor: '#fff',
                            borderColor: '#00d9ff',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        function renderPodium() {
            if (standings.length >= 3) {
                podium.style.display = 'flex';

                for (let i = 0; i < 3; i++) {
                    const place = standings[i];
                    const podiumItem = document.getElementById(`podium-${i + 1}`);
                    podiumItem.querySelector('.podium-name').textContent = place.name;
                    podiumItem.querySelector('.podium-score').textContent = `${place.score} pts`;
                }
            }
        }

        function renderScoreboard() {
            scoreboardBody.innerHTML = '';

            standings.forEach((entry, index) => {
                const row = document.createElement('tr');

                let rankClass = '';
                if (index === 0) rankClass = 'rank-1';
                else if (index === 1) rankClass = 'rank-2';
                else if (index === 2) rankClass = 'rank-3';

                const mode = '{{ get_config("user_mode") }}';
                const profileUrl = mode === 'teams' ? `/teams/${entry.account_id}` : `/users/${entry.account_id}`;

                row.className = rankClass;
                row.innerHTML = `
                <td>
                    <span class="rank-number">${index + 1}</span>
                </td>
                <td>
                    <a href="${profileUrl}" class="text-cyan">
                        ${entry.name}
                    </a>
                </td>
                <td>
                    <span class="score-value">${entry.score}</span>
                </td>
            `;

                scoreboardBody.appendChild(row);
            });
        }

        async function updateStats() {
            try {
                const chalResp = await fetch('/api/v1/challenges');
                const chalData = await chalResp.json();
                if (chalData.success) {
                    document.getElementById('total-challenges').textContent = chalData.data.length;
                }

                document.getElementById('total-teams').textContent = standings.length;

                // Calculate total solves
                let totalSolves = 0;
                standings.forEach(team => {
                    if (team.solves) {
                        totalSolves += team.solves.length;
                    }
                });
                document.getElementById('total-solves').textContent = totalSolves || standings.length;

            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Auto-refresh every 60 seconds
        setInterval(fetchScoreboard, 60000);

        // Initialize
        fetchScoreboard();
    })();
</script>
{% endblock %}