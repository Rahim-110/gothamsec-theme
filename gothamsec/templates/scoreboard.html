{% extends "base.html" %}

{% block title %}Scoreboard - {{ get_config("ctf_name") }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="hero" style="min-height: 25vh; padding: 2rem 0;">
        <div class="hero-content">
            <h1 class="hero-title">Scoreboard</h1>
            <p class="hero-subtitle">Real-time rankings. Who will claim the crown?</p>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="d-flex justify-center gap-3 mb-4" style="flex-wrap: wrap;">
        <div class="glass-panel text-center" style="padding: 1.5rem 2rem; min-width: 150px;">
            <div class="text-cyan" style="font-size: 2rem; font-weight: 700;" id="total-teams">--</div>
            <div class="text-muted">{{ 'Teams' if get_config('user_mode') == 'teams' else 'Players' }}</div>
        </div>
        <div class="glass-panel text-center" style="padding: 1.5rem 2rem; min-width: 150px;">
            <div class="text-purple" style="font-size: 2rem; font-weight: 700;" id="total-solves">--</div>
            <div class="text-muted">Total Solves</div>
        </div>
        <div class="glass-panel text-center" style="padding: 1.5rem 2rem; min-width: 150px;">
            <div class="text-cyan" style="font-size: 2rem; font-weight: 700;" id="total-challenges">--</div>
            <div class="text-muted">Challenges</div>
        </div>
    </div>

    <!-- Scoreboard Table -->
    <div class="glass-panel">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--gth-cyan);">
                    <th style="width: 100px; padding: 1rem; text-align: left; color: var(--gth-cyan);">Place</th>
                    <th style="padding: 1rem; text-align: left; color: var(--gth-cyan);">{{ 'Team' if
                        get_config('user_mode') == 'teams' else 'Player' }}</th>
                    <th style="width: 150px; padding: 1rem; text-align: right; color: var(--gth-cyan);">Score</th>
                </tr>
            </thead>
            <tbody id="scoreboard-body">
                <!-- Rows loaded dynamically -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const scoreboardBody = document.getElementById('scoreboard-body');
        let standings = [];

        async function fetchScoreboard() {
            try {
                const response = await fetch('/api/v1/scoreboard');

                if (!response.ok) {
                    throw new Error('Scoreboard API returned ' + response.status);
                }

                const data = await response.json();

                if (data.success && data.data) {
                    standings = data.data;
                    renderScoreboard();
                    updateStats();
                } else {
                    scoreboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem; color: #888;">No scoreboard data available</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching scoreboard:', error);
                scoreboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem; color: #888;">Failed to load scoreboard</td></tr>';
            }
        }

        function renderScoreboard() {
            scoreboardBody.innerHTML = '';

            if (standings.length === 0) {
                scoreboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem; color: #888;">No teams on scoreboard yet</td></tr>';
                return;
            }

            standings.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid rgba(0, 217, 255, 0.2)';

                let rankStyle = 'color: #ccc;';
                let rankIcon = '';
                if (index === 0) {
                    rankStyle = 'color: #ffd700;';
                    rankIcon = 'ðŸ¥‡ ';
                } else if (index === 1) {
                    rankStyle = 'color: #c0c0c0;';
                    rankIcon = 'ðŸ¥ˆ ';
                } else if (index === 2) {
                    rankStyle = 'color: #cd7f32;';
                    rankIcon = 'ðŸ¥‰ ';
                }

                const mode = '{{ get_config("user_mode") }}';
                const profileUrl = mode === 'teams' ? `/teams/${entry.account_id}` : `/users/${entry.account_id}`;

                row.innerHTML = `
                    <td style="padding: 1rem; ${rankStyle} font-weight: 600; font-size: 1.1rem;">
                        ${rankIcon}${index + 1}
                    </td>
                    <td style="padding: 1rem;">
                        <a href="${profileUrl}" style="color: var(--gth-cyan); text-decoration: none; font-weight: 500;">
                            ${entry.name}
                        </a>
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 700; color: var(--gth-purple); font-size: 1.1rem;">
                        ${entry.score}
                    </td>
                `;

                row.style.transition = 'background 0.2s';
                row.addEventListener('mouseenter', () => row.style.background = 'rgba(0, 217, 255, 0.1)');
                row.addEventListener('mouseleave', () => row.style.background = 'transparent');

                scoreboardBody.appendChild(row);
            });
        }

        async function updateStats() {
            try {
                const chalResp = await fetch('/api/v1/challenges');
                const chalData = await chalResp.json();
                if (chalData.success) {
                    document.getElementById('total-challenges').textContent = chalData.data.length;
                }

                document.getElementById('total-teams').textContent = standings.length;

                let totalSolves = 0;
                standings.forEach(team => {
                    if (team.solves) {
                        totalSolves += team.solves.length;
                    }
                });
                document.getElementById('total-solves').textContent = totalSolves || standings.length;

            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        setInterval(fetchScoreboard, 60000);
        fetchScoreboard();
    })();
</script>
{% endblock %}